name: "NetProbe Main CI/CD Pipeline"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_ID: "netprobe-473119"
  REGION: "asia-south1"
  REPO_ID: "netprobe-docker-repo"
  API_SERVICE_NAME: "netprobe-api"
  DASHBOARD_SERVICE_NAME: "netprobe-dashboard"

jobs:
  # ======================================================================================
  # JOB 1: RUNS ON PULL REQUESTS
  # ======================================================================================
  plan_and_build_pr:
    name: "PR Check: Plan Infra & Build Apps"
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4
      - name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      
      - name: "Set up Terraform"
        uses: hashicorp/setup-terraform@v3
      - name: "Terraform Init (PR)"
        working-directory: ./infra/terraform
        run: terraform init
      - name: "Terraform Plan (PR)"
        working-directory: ./infra/terraform
        env:
          TF_VAR_db_password: "dummy-password-for-plan"
        run: terraform plan -input=false -var="nva_instance_count=1" -var="branch_name=${{ github.head_ref }}" -var="app_version=${{ github.event.pull_request.head.sha }}" -var-file="terraform.tfvars"

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"
      - run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
      - name: "Build App Images (PR)"
        run: |
          docker build --no-cache -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_ID }}/${{ env.API_SERVICE_NAME }}:${{ github.sha }} ./apps/api
          docker build --no-cache -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_ID }}/${{ env.DASHBOARD_SERVICE_NAME }}:${{ github.sha }} ./apps/dashboard

  # ======================================================================================
  # JOB 2: DEPLOY INFRASTRUCTURE (Runs on Merge to main)
  # ======================================================================================
  apply-infra:
    name: "Deploy Infrastructure"
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"
    outputs:
      workload_vm_name: ${{ steps.tf-outputs.outputs.test_workload_vm_name }}
      workload_vm_zone: ${{ steps.tf-outputs.outputs.test_workload_vm_zone }}
      db_connection_name: ${{ steps.tf-outputs.outputs.db_connection_name }}
    steps:
      - uses: actions/checkout@v4
      - uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - uses: hashicorp/setup-terraform@v3
      - name: "Terraform Init"
        working-directory: ./infra/terraform
        run: terraform init
      - name: "Terraform Apply"
        working-directory: ./infra/terraform
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        run: terraform apply -auto-approve -var="nva_instance_count=1" -var="branch_name=main" -var="app_version=${{ github.sha }}" -var-file="terraform.tfvars"
      
      - name: "Set up Cloud SDK"
        uses: 'google-github-actions/setup-gcloud@v2'
      
      - name: "Wait for NVA Rolling Update to Complete"
        run: |
          echo "--- Waiting for NVA Managed Instance Group to become stable... ---"
          gcloud compute instance-groups managed wait-until netprobe-nva-mig \
            --region=${{ env.REGION }} \
            --stable
          echo "--- NVA cluster is stable. Proceeding. ---"
      
      - name: "Trigger Cloud Build for Schema Creation"
        if: "!contains(github.event.head_commit.message, '[skip-builds]')"
        run: 'gcloud builds submit --config=cloudbuild-schema.yaml --project=${{ env.PROJECT_ID }} --region=${{ env.REGION }} --quiet'

      - name: "Get Terraform Outputs for Validation Jobs"
        id: tf-outputs
        working-directory: ./infra/terraform
        run: |
          echo "test_workload_vm_name=$(terraform output -raw test_workload_vm_name)" >> $GITHUB_OUTPUT
          echo "workload_vm_zone=$(terraform output -raw test_workload_vm_zone)" >> $GITHUB_OUTPUT
          echo "db_connection_name=$(terraform output -raw db_connection_name)" >> $GITHUB_OUTPUT
          
      - name: "Update Live DB IP in Secret Manager"
        run: |
          DB_IP=$(cd ./infra/terraform && terraform output -raw netprobe_db_private_ip)
          echo "$DB_IP" | gcloud secrets versions add db-private-ip-live --data-file=-

      - name: "Wait for IAM Propagation"
        if: always()
        run: |
          echo "--- Waiting 60 seconds for IAM permissions to propagate... ---"
          sleep 60
          echo "--- Proceeding. ---"
  # ======================================================================================
  # JOB 3: DEPLOY API (Runs on Merge to main, after Infra)
  # ======================================================================================
  deploy-api:
    name: "Build and Deploy API"
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: apply-infra 
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"
    outputs:
      api_url: ${{ steps.deploy_api.outputs.api_url }}
    steps:
      - uses: actions/checkout@v4
      
      - name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: "google-github-actions/setup-gcloud@v2"
      - run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: "Build and Push API Image"
        run: |
          docker build --no-cache -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_ID }}/${{ env.API_SERVICE_NAME }}:${{ github.sha }} ./apps/api
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_ID }}/${{ env.API_SERVICE_NAME }}:${{ github.sha }}
          
      - name: "Fetch Live Database IP"
        id: get_db_ip
        run: |
          LIVE_DB_IP=$(gcloud secrets versions access latest --secret="db-private-ip-live" --project=${{ env.PROJECT_ID }})
          if [ -z "$LIVE_DB_IP" ]; then
            echo "!!! CRITICAL: Failed to fetch 'db-private-ip-live' from Secret Manager."
            exit 1
          fi
          echo "DB_HOST=$LIVE_DB_IP" >> $GITHUB_ENV
          
      - name: "Deploy API to Cloud Run (with Retry)"
        id: deploy_api
        run: |
          set -e
          for i in 1 2 3; do
            echo "--- Deploy attempt $i of 3 ---"
            gcloud run deploy ${{ env.API_SERVICE_NAME }} \
              --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_ID }}/${{ env.API_SERVICE_NAME }}:${{ github.sha }} \
              --region=${{ env.REGION }} \
              --vpc-connector="netprobe-vpc-connector" \
              --vpc-egress=private-ranges-only \
              --ingress=internal \
              --service-account=sa-netprobe-api@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
              --set-env-vars="DB_HOST=${{ env.DB_HOST }}" \
              --no-allow-unauthenticated \
              && echo "--- Deploy successful on attempt $i ---" \
              && break
            
            if [ $i -lt 3 ]; then
              echo "--- Deploy failed. Waiting 30 seconds for IAM to propagate... ---"
              sleep 30
            else
              echo "--- Deploy failed on all 3 attempts. ---"
              exit 1
            fi
          done
          
          API_URL=$(gcloud run services describe ${{ env.API_SERVICE_NAME }} --region=${{ env.REGION }} --format="value(status.url)")
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "--- API URL: $API_URL ---"

  # ======================================================================================
  # JOB 4: DEPLOY DASHBOARD (Runs on Merge, after API deployment)
  # ======================================================================================
  deploy-dashboard:
    name: "Build and Deploy Dashboard"
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: deploy-api 
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"
    steps:
      - uses: actions/checkout@v4
      
      - name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          
      - uses: "google-github-actions/setup-gcloud@v2"
      - run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
      - name: "Build and Push Dashboard Image"
        run: |
          docker build --no-cache -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_ID }}/${{ env.DASHBOARD_SERVICE_NAME }}:${{ github.sha }} ./apps/dashboard
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_ID }}/${{ env.DASHBOARD_SERVICE_NAME }}:${{ github.sha }}
          
      - name: "Deploy Dashboard to Cloud Run"
        run: |
          gcloud run deploy ${{ env.DASHBOARD_SERVICE_NAME }} \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_ID }}/${{ env.DASHBOARD_SERVICE_NAME }}:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --vpc-connector="netprobe-vpc-connector" \
            --vpc-egress=all-traffic \
            --service-account=sa-netprobe-dashboard@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
            --set-env-vars="^::^API_TARGET_URL=${{ needs.deploy-api.outputs.api_url }}::API_AUDIENCE_URL=${{ needs.deploy-api.outputs.api_url }}" \
            --allow-unauthenticated
  # =====================================================================================
  # JOB 5: VALIDATE DEPLOYMENT (Runs on Merge, after Apps are deployed)
  # =====================================================================================
  validate:
    name: "Validate Deployment"
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [apply-infra, deploy-dashboard] 
    runs-on: ubuntu-latest
    permissions:
      contents: "read" 
      id-token: "write"
    steps:
      - uses: actions/checkout@v4
      
      - name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          
      - uses: hashicorp/setup-terraform@v3
      - name: "Terraform Init" 
        working-directory: ./infra/terraform
        run: terraform init
      - name: "Wait for NVA startup scripts"
        if: "!contains(github.event.head_commit.message, '[skip-builds]')"
        run: sleep 150
      
      - name: "Set up Cloud SDK"
        uses: 'google-github-actions/setup-gcloud@v2'
        
      - name: "Get Terraform Outputs"
        id: tf-outputs
        working-directory: ./infra/terraform
        run: |
          set -e
          terraform init
          echo "workload_vm_name=$(terraform output -raw test_workload_vm_name)" >> $GITHUB_OUTPUT
          echo "workload_vm_zone=$(terraform output -raw test_workload_vm_zone)" >> $GITHUB_OUTPUT
          echo "db_connection_name=$(terraform output -raw db_connection_name)" >> $GITHUB_OUTPUT
        
      - name: "Run Live Traffic Test via gcloud"
        run: |
          echo "--- Generating SSH keys non-interactively ---"
          ssh-keygen -t rsa -N '' -f ~/.ssh/google_compute_engine -q

          echo "--- Triggering traffic from workload VM: ${{ steps.tf-outputs.outputs.workload_vm_name }} ---"
          gcloud compute ssh ${{ steps.tf-outputs.outputs.workload_vm_name }} \
            --zone=${{ steps.tf-outputs.outputs.workload_vm_zone }} \
            --tunnel-through-iap \
            --quiet \
            --command="curl -v https://google.com"

      - name: "Trigger Cloud Build for Validation"
        if: "!contains(github.event.head_commit.message, '[skip-builds]')"
        run: |
          gcloud builds submit --config=cloudbuild-validate.yaml --project=${{ env.PROJECT_ID }} --region=${{ env.REGION }} --quiet

      - name: "Cleanup Test VM"
        if: always()
        working-directory: ./infra/terraform
        env:
          TF_VAR_db_password: "dummy-password-for-cleanup"
        run: |
          terraform init 
          terraform destroy -auto-approve \
            -target=google_compute_instance.test_workload[0] \
            -var="app_version=cleanup-${{ github.run_id }}" \
            -var="branch_name=cleanup"