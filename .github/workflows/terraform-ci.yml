name: "Terraform CI/CD"

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # ======================================================================================
  # JOB 1: TERRAFORM PLAN (Runs on Pull Request)
  # ======================================================================================
  plan:
    name: "Terraform Plan on PR"
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4

      - name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: "Set up Terraform"
        uses: hashicorp/setup-terraform@v3

      - name: "Terraform Init"
        working-directory: ./infra/terraform
        run: terraform init

      - name: "Terraform Plan"
        working-directory: ./infra/terraform
        env:
          TF_VAR_db_password: "dummy-password-for-plan"
        run: terraform plan -input=false -var="nva_instance_count=1" -var="branch_name=${{ github.head_ref }}" -var="app_version=${{ github.event.pull_request.head.sha }}" -var-file="terraform.tfvars"
  
  # ======================================================================================
  # JOB 2: TERRAFORM APPLY (Runs on Merge to Main)
  # ======================================================================================
  apply:
    name: "Terraform Apply to Main"
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4

      - name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: "Set up Terraform"
        uses: hashicorp/setup-terraform@v3

      - name: "Terraform Init"
        working-directory: ./infra/terraform
        run: terraform init

      - name: "Terraform Apply"
        working-directory: ./infra/terraform
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        run: terraform apply -auto-approve -var="nva_instance_count=2" -var="branch_name=main" -var="app_version=${{ github.sha }}" -var-file="terraform.tfvars"

      - name: "Create Database Schema"
        working-directory: ./infra/terraform
        env:
          PGPASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          echo "--- Applying database schema with proxy and enhanced debugging ---"
          
          # Install tools
          sudo apt-get update && sudo apt-get install -y postgresql-client
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.10.0/cloud-sql-proxy.linux.amd64 && chmod +x cloud-sql-proxy
          
          # Get the database connection name
          DB_CONNECTION_NAME=$(terraform output -raw db_connection_name)
          
          # --- DEBUGGING STEP: START PROXY AND CAPTURE LOGS ---
          echo "--- Attempting to start Cloud SQL Proxy in the background... ---"
          # We run the proxy in the background and redirect its output to a log file
          ./cloud-sql-proxy --ip-address-types=PRIVATE $DB_CONNECTION_NAME > proxy.log 2>&1 &
          
          # Wait a few seconds to give it time to start up or fail
          sleep 5
          
          # --- DEBUGGING STEP: PRINT THE PROXY LOG ---
          echo "--- Displaying Cloud SQL Proxy log output: ---"
          cat proxy.log
          echo "--- End of proxy log output ---"

          # Now, we proceed with the connection test as before
          echo "Waiting for Cloud SQL Proxy to be ready on localhost..."
          for i in {1..10}; do
            if pg_isready -h 127.0.0.1 -U netprobe_user -d netprobe_logs; then
              echo "✅ Proxy is ready and connected to the database."
              break
            fi
            echo "Attempt $i/10 failed. Waiting 15 seconds..."
            sleep 15
          done

          if ! pg_isready -h 127.0.0.1 -U netprobe_user -d netprobe_logs; then
            echo "❌ Cloud SQL Proxy did not become ready."
            # We print the log again on final failure for clarity
            echo "--- Final proxy log output: ---"
            cat proxy.log
            exit 1
          fi

          # If the loop succeeds, we apply the schema
          echo "--- Proxy is ready. Applying schema. ---"
          psql --host=127.0.0.1 --username=netprobe_user --dbname=netprobe_logs <<-EOF
            CREATE TABLE connections (
                id SERIAL PRIMARY KEY,
                ts TIMESTAMP WITH TIME ZONE NOT NULL,
                uid VARCHAR(255) UNIQUE NOT NULL,
                source_ip INET NOT NULL,
                source_port INTEGER NOT NULL,
                destination_ip INET NOT NULL,
                destination_port INTEGER NOT NULL,
                proto VARCHAR(6),
                service VARCHAR(255),
                duration FLOAT,
                orig_bytes BIGINT,
                resp_bytes BIGINT,
                conn_state VARCHAR(10),
                logged_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
            );
          EOF
          echo "--- Schema applied successfully ---"

  # ======================================================================================
  # JOB 3: VALIDATE DEPLOYMENT (Runs after Apply on Merge to Main)
  # ======================================================================================
  validate:
    name: "Validate Deployment"
    needs: apply 
    runs-on: ubuntu-latest
    permissions:
      contents: "read" 
      id-token: "write"

    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4

      - name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: "Set up Terraform"
        uses: hashicorp/setup-terraform@v3

      - name: "Terraform Init" 
        working-directory: ./infra/terraform
        run: terraform init

      - name: "Wait for NVA startup scripts"
        run: sleep 300

      - name: "Get Terraform Outputs"
        id: tf-outputs
        working-directory: ./infra/terraform
        run: |
          echo "workload_vm_name=$(terraform output -raw test_workload_vm_name)" >> $GITHUB_ENV
          echo "workload_vm_zone=$(terraform output -raw test_workload_vm_zone)" >> $GITHUB_ENV
          echo "db_connection_name=$(terraform output -raw db_connection_name)" >> $GITHUB_ENV
      
      - name: "Run Live Traffic Test"
        run: |
          echo "--- Triggering traffic from workload VM: ${{ env.workload_vm_name }} ---"
          gcloud compute ssh ${{ env.workload_vm_name }} \
            --zone=${{ env.workload_vm_zone }} \
            --tunnel-through-iap \
            --command="curl -v https://google.com"

      - name: "Validate Database Records"
        run: |
          chmod +x ./scripts/validate-db.sh
          ./scripts/validate-db.sh
        env:
          DB_CONNECTION_NAME: ${{ env.db_connection_name }}

      - name: "Cleanup Test VM"
        if: always()
        working-directory: ./infra/terraform
        env:
          TF_VAR_db_password: "dummy-password-for-cleanup"
        run: |
          terraform init 
          terraform destroy -auto-approve -target=google_compute_instance.test_workload[0]
