steps:
  # Step 1: Install tools
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'setup_tools'
    entrypoint: 'bash'
    args: ['-c', 'set -e; apt-get update && apt-get install -y postgresql-client curl; curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.10.0/cloud-sql-proxy.linux.amd64; chmod +x cloud-sql-proxy']

  # Step 2: Start Proxy & Apply Schema
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'apply_schema'
    entrypoint: 'bash'
    args:
        - '-c'
        - |
          set -e
          if [ -z "$$PGPASSWORD" ]; then
            echo "ERROR: PGPASSWORD is empty!"
            exit 1
          else
            echo "SUCCESS: PGPASSWORD is set (length: $${#PGPASSWORD})"
          fi
          echo "--- Starting Cloud SQL Proxy ---"
          # Construct connection name DIRECTLY in the command using substitutions
          ./cloud-sql-proxy --private-ip "projects/${PROJECT_ID}/locations/${_SQL_REGION}/instances/${_SQL_INSTANCE_NAME}" &
          sleep 5 # Give proxy time to start (no PID capture needed)

          echo "Waiting for proxy..."
          if ! pg_isready -h 127.0.0.1 -U "${_SQL_USER}" -d "${_SQL_DBNAME}" -t 15; then
            echo "Proxy did not become ready quickly."
            pkill -f cloud-sql-proxy || true # Kill by name
            exit 1
          fi

          echo "--- Applying schema ---"
          psql --host=127.0.0.1 --username="${_SQL_USER}" --dbname="${_SQL_DBNAME}" <<-EOF
            CREATE TABLE connections ( id SERIAL PRIMARY KEY, ts TIMESTAMP WITH TIME ZONE NOT NULL, uid VARCHAR(255) UNIQUE NOT NULL, source_ip INET NOT NULL, source_port INTEGER NOT NULL, destination_ip INET NOT NULL, destination_port INTEGER NOT NULL, proto VARCHAR(6), service VARCHAR(255), duration FLOAT, orig_bytes BIGINT, resp_bytes BIGINT, conn_state VARCHAR(10), logged_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() );
          EOF
          echo "--- Schema applied successfully ---"

          echo "--- Shutting down proxy ---"
          pkill -f cloud-sql-proxy || echo "Proxy already stopped."

substitutions:
  _SQL_REGION: 'asia-south1'
  _SQL_INSTANCE_NAME: 'netprobe-db'
  _SQL_USER: 'netprobe_user'
  _SQL_DBNAME: 'netprobe_logs'

availableSecrets:
  secretManager:
  - versionName: projects/${PROJECT_ID}/secrets/db-password/versions/latest
    env: 'PGPASSWORD'

timeout: '600s'
